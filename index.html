<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOXL + QQQ RSI Mode</title>
    <link rel="stylesheet" href="css/style.css?v=3">
    <link rel="stylesheet" href="css/mobile.css?v=3" media="(max-width: 768px)">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="js/app_v2.js?v=final_fix"></script>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header>
            <div class="logo">
                <button id="sidebarToggle" class="icon-btn" style="margin-right:0.5rem; font-size:1.2rem;">‚ò∞</button>
                üìä SOXL + QQQ
            </div>

            <div class="header-toggles">
                <label><input type="checkbox" id="toggleCashChart"> ÏòàÏàòÍ∏à ON</label>
                <label><input type="checkbox" id="toggleAssetChart"> Ï¥ùÏûêÏÇ∞ ON</label>
                <label><input type="checkbox" id="toggleDDChart"> DD ON</label>
                <label style="margin-left: 10px; color: #fbbf24;"><input type="checkbox" id="toggleRobustness"> üî¨
                    Robustness</label>
                <label style="margin-left: 10px; color: #8b5cf6;"><input type="checkbox" id="toggleSavedStrategies">
                    ÏûÑÏãúÎ≥¥Í¥Ä</label>
                <label style="margin-left: 10px; color: #10b981;"><input type="checkbox" id="toggleWarehouse">
                    ÌååÎùºÎØ∏ÌÑ∞ Ï∞ΩÍ≥†</label>

                <!-- Injection Buttons (Visible only in Trading Sheet) -->
                <button id="btnInjSeed" class="hidden"
                    style="margin-left:10px; padding:3px 8px; font-size:0.8rem; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;">
                    üí∏ ÏãúÎìúÎ≥ÄÎèô
                </button>
                <button id="btnInjCash" class="hidden"
                    style="margin-left:5px; padding:3px 8px; font-size:0.8rem; background:#2563eb; color:white; border:none; border-radius:4px; cursor:pointer;">
                    üíµ ÏòàÏàòÍ∏àÎ≥ÄÎèô
                </button>
            </div>

            <div class="actions">
                <button id="btnOrderSheet" class="header-btn hidden">Ï£ºÎ¨∏Ìëú</button>
                <button id="btnDeepMind" class="header-btn">DEEP MIND</button>
                <button id="btnExportBot" class="header-btn" style="background-color: #4b5563;">ü§ñ Î¥áÏÑ§Ï†ïÎ≥µÏÇ¨</button>
                <button id="themeToggle" class="icon-btn">üåô</button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main>
            <!-- Sidebar: Configuration -->
            <aside class="config-panel">
                <section class="card">
                    <h3>üõ† Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
                    <div class="form-grid">
                        <label>Ï¥àÍ∏∞ÏûêÎ≥∏($)
                            <button id="btnSaveSeed" class="hidden"
                                style="margin-left:5px; padding:2px 8px; font-size:0.75rem; background:#10b981; color:white; border:none; border-radius:4px; cursor:pointer;"
                                title="ÌòÑÏû¨ Í∞í Ï†ÄÏû•">üíæ</button> <!-- Save Button -->
                            <input type="number" id="initCapital" value="10000">
                        </label>
                        <label>ÏàòÏàòÎ£å(%) <input type="number" id="feeRate" value="0" step="0.01"></label>
                        <label>ÏãúÏûëÏùº <input type="date" id="startDate" value="2018-01-01"></label>
                        <label>Ï¢ÖÎ£åÏùº <input type="date" id="endDate" value="2025-12-31"></label>

                        <!-- Quick Date Buttons -->
                        <div class="date-btn-container">
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate1">1</button>
                                <span class="date-label">Ïò¨Ìï¥</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate2">2</button>
                                <span class="date-label">ÏµúÍ∑º1ÎÖÑ</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate3">3</button>
                                <span class="date-label">ÏµúÍ∑º3ÎÖÑ</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate4">4</button>
                                <span class="date-label">ÏµúÍ∑º5ÎÖÑ</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate5">5</button>
                                <span class="date-label">ÏµúÍ∑º8ÎÖÑ</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate6">6</button>
                                <span class="date-label">Ï†ÑÏ≤¥</span>
                            </div>
                            <div class="date-btn-wrapper">
                                <button class="circle-btn-date" id="btnDate7">7</button>
                                <span class="date-label">Îã§Ïùå ÎÇ†</span>
                            </div>
                        </div>
                        <div
                            style="grid-column: 1 / -1; border-top: 1px solid #eee; margin-top: 0.5rem; padding-top: 0.5rem;">
                            <!-- Real Tier Toggle Switch (Top) -->
                            <div class="switch-container" style="margin-bottom: 0.5rem; justify-content: center;">
                                <span>Tier Î∞©Ïãù</span>
                                <label class="switch">
                                    <input type="checkbox" id="toggleRealTier" checked>
                                    <span class="slider round"></span>
                                </label>
                                <span style="color: #2563eb;">Real Tier Î∞©Ïãù</span>
                            </div>

                            <!-- Trading Sheet Toggle -->
                            <div class="switch-container"
                                style="margin-bottom: 0.5rem; justify-content: center; margin-top:10px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                                <span style="font-size:0.9rem; color:#64748b;">Î∞±ÌÖåÏä§ÌÑ∞</span>
                                <label class="switch">
                                    <input type="checkbox" id="toggleMode">
                                    <span class="slider round"
                                        style="background:linear-gradient(45deg, #8b5cf6, #d946ef);"></span>
                                </label>
                                <span style="font-size:0.9rem; font-weight:bold; color:#8b5cf6;">Îß§Îß§ ÏãúÌä∏</span>
                            </div>

                            <!-- Save/Use Defaults Button (Hidden by default, shown in Trading Sheet Mode) -->
                            <button id="btnUseDefaults" class="hidden"
                                style="width:100%; margin-top:5px; padding:10px; background:#10b981; color:white; border:none; border-radius:6px; font-weight:bold; cursor:pointer;">
                                ‚úÖ ÌòÑÏû¨ ÏÑ§Ï†ï ÏÇ¨Ïö© (Save Defaults)
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Seed Input Modal -->
                <div id="seedModal" class="modal hidden"
                    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center;">
                    <div class="modal-content"
                        style="background: white; padding: 2rem; border-radius: 12px; max-width: 90%; width: 400px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <h3 style="margin-bottom: 15px; color:#1e1e1e;">üí∞ Ï¥àÍ∏∞ ÏãúÎìú ÏÑ§Ï†ï (Initial Capital)</h3>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 20px;">Ïò¨Ìï¥ Îß§Îß§Î•º ÏãúÏûëÌï† ÎïåÏùò ÏõêÍ∏àÏùÑ
                            ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.<br>(Ï†ÄÏû•Ïù¥ÌõÑÏóêÎäî ÏûêÎèôÏúºÎ°ú Î∂àÎü¨ÏòµÎãàÎã§)</p>
                        <input type="number" id="modalSeedInput"
                            style="width: 100%; padding: 12px; font-size: 1.2rem; border: 2px solid #e2e8f0; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="display: flex; gap: 10px;">
                            <button id="btnSaveModalSeed"
                                style="flex: 1; background: #2563eb; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">ÌôïÏù∏
                                Î∞è Ï†ÄÏû•</button>
                            <button id="btnCloseSeedModal"
                                style="flex: 1; background: #94a3b8; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">Ï∑®ÏÜå</button>
                        </div>
                    </div>
                </div>

                <section class="card">
                    <h3 class="header-safe">üõ° Safe Mode (ÏïàÏ†Ñ)</h3>
                    <div class="form-row">
                        <label>Îß§Ïàò(Loc %) <input type="number" id="safeBuyLimit" value="3" step="0.1"></label>
                        <label>ÏùµÏ†à(Target %) <input type="number" id="safeTarget" value="0.2" step="0.1"></label>
                        <label>Î≥¥Ïú†(Day) <input type="number" id="safeTimeCut" value="30"></label>
                    </div>
                    <h4>Î∂ÑÌï† ÎπÑÏ§ë (1~7Ï∞®) %</h4>
                    <div class="weight-grid" id="safeWeights">
                        <div class="weight-item"><span class="weight-label">1</span><input type="number" value="0">
                        </div>
                        <div class="weight-item"><span class="weight-label">2</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">3</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">4</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">5</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">6</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">7</span><input type="number" value="0">
                        </div>
                        <div class="weight-item"><span class="weight-label">8</span><input type="number"
                                id="safeWeight8" value="0" disabled style="opacity:0.3"></div>
                    </div>
                </section>

                <section class="card">
                    <h3 class="header-offensive">‚öî Offensive Mode (Í≥µÏÑ∏)</h3>
                    <div class="form-row">
                        <label>Îß§Ïàò(Loc %) <input type="number" id="offBuyLimit" value="4" step="0.1"></label>
                        <label>ÏùµÏ†à(Target %) <input type="number" id="offTarget" value="3" step="0.1"></label>
                        <label>Î≥¥Ïú†(Day) <input type="number" id="offTimeCut" value="7"></label>
                    </div>
                    <h4>Î∂ÑÌï† ÎπÑÏ§ë (1~7Ï∞®) %</h4>
                    <div class="weight-grid" id="offWeights">
                        <div class="weight-item"><span class="weight-label">1</span><input type="number" value="0">
                        </div>
                        <div class="weight-item"><span class="weight-label">2</span><input type="number" value="0">
                        </div>
                        <div class="weight-item"><span class="weight-label">3</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">4</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">5</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">6</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">7</span><input type="number" value="20">
                        </div>
                        <div class="weight-item"><span class="weight-label">8</span><input type="number" id="offWeight8"
                                value="0" disabled style="opacity:0.3"></div>
                    </div>
                </section>

                <section class="card">
                    <h3>‚öñ Rebalancing (10 Days)</h3>
                    <div class="form-row">
                        <label>Ïù¥Ïùµ Í∞ÄÏÇ∞(%) <input type="number" id="profitAdd" value="70"></label>
                        <label>ÏÜêÏã§ Ï∞®Í∞ê(%) <input type="number" id="lossSub" value="20"></label>
                    </div>
                </section>

                <div style="display:flex; gap:0.5rem; margin-top:1rem;">
                    <button id="runBtn" class="primary-btn" style="flex:2;">ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏãúÏûë (RUN)</button>
                    <button id="btnSaveCurrentParams" class="primary-btn" style="flex:1; background:#10b981;"
                        title="ÌòÑÏû¨ ÌååÎùºÎØ∏ÌÑ∞ Ï∞ΩÍ≥† Ï†ÄÏû•">üíæ</button>
                </div>
            </aside>

            <!-- Main Area: Results -->
            <section class="results-area">
                <!-- Order Sheet (Hidden by default) -->
                <div id="orderSheetArea" class="card hidden"
                    style="border: 2px solid #2563eb; background: #f0f9ff; margin-bottom: 1rem;">
                    <!-- Injected by JS -->
                </div>

                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="kpi-card" style="border-top-color: #ef4444;">
                        <div class="label">TOTAL RETURN (Ï¥ùÏàòÏùµÎ•†)</div>
                        <div class="value" id="kpiReturn" style="color: #ef4444;">0%</div>
                        <div class="sub" id="kpiSeed">Seed: $40,000</div>
                    </div>
                    <div class="kpi-card" style="border-top-color: #a855f7;">
                        <div class="label">CAGR (Ïó∞ÌèâÍ∑†)</div>
                        <div class="value" id="kpiCagr" style="color: #a855f7;">0%</div>
                        <div class="sub">Growth Rate</div>
                    </div>
                    <div class="kpi-card" style="border-top-color: #334155;">
                        <div class="label">FINAL ASSET</div>
                        <div class="value" id="kpiFinal" style="color: #334155;">$0</div>
                        <div class="sub">End Value</div>
                    </div>
                    <div class="kpi-card" style="border-top-color: #3b82f6;">
                        <div class="label">MAX DRAWDOWN</div>
                        <div class="value" id="kpiMdd" style="color: #3b82f6;">0%</div>
                        <div class="sub" id="kpiMddDate">Risk Level</div> <!-- Added ID -->
                    </div>
                    <div class="kpi-card" style="border-top-color: #10b981;">
                        <div class="label">WIN RATE</div>
                        <div class="value" id="kpiWinRate" style="color: #10b981;">0%</div>
                        <div class="sub" id="kpiCount">Count: 0</div>
                    </div>
                    <div class="kpi-card" style="border-top-color: #fbbf24;">
                        <div class="label">SQN (>3.0 Good)</div>
                        <div class="value" id="kpiSqn" style="color: #fbbf24;">0.00</div>
                        <div class="sub">System Quality</div>
                    </div>
                    <!-- Placeholder 1 -->
                    <div class="kpi-card" style="border-top-color: #94a3b8;">
                        <div class="label">EXTRA INFO 1</div>
                        <div class="value" id="kpiExtra1" style="color: #94a3b8;">-</div>
                        <div class="sub">TBD</div>
                    </div>
                    <!-- Placeholder 2 -->
                    <div class="kpi-card" style="border-top-color: #94a3b8;">
                        <div class="label">EXTRA INFO 2</div>
                        <div class="value" id="kpiExtra2" style="color: #94a3b8;">-</div>
                        <div class="sub">TBD</div>
                    </div>
                </div>

                <!-- NEW: Integrated Robustness Analysis -->
                <div id="robustnessReport" class="hidden"
                    style="margin-bottom: 2rem; background: #1e293b; padding: 1.5rem; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; border-bottom: 1px solid #475569; padding-bottom: 0.5rem;">
                        <h3
                            style="margin: 0; color: #f8fafc; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span>üî¨</span> Reliability Seven (Robustness Test)
                        </h3>
                        <span id="rbMainStatus"
                            style="font-size: 0.9rem; color: #fbbf24; font-weight: bold;">Waiting...</span>
                    </div>

                    <!-- Progress -->
                    <div id="rbMainLoading" class="hidden" style="margin-bottom: 1.5rem;">
                        <div class="progress-bar"
                            style="height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                            <div id="rbMainProgress"
                                style="width: 0%; height: 100%; background: linear-gradient(90deg, #ec4899, #8b5cf6); transition: width 0.3s;">
                            </div>
                        </div>
                    </div>

                    <!-- Stats Grid (Dark Theme) -->
                    <div id="rbMainStats" class="hidden">
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <!-- Survival Rate -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    Survival Rate</div>
                                <div id="rbMainSurvival" style="font-size: 1.3rem; font-weight: 700; color: #f8fafc;">0%
                                </div>
                            </div>
                            <!-- Avg CAGR -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    Avg CAGR</div>
                                <div id="rbMainCagr" style="font-size: 1.3rem; font-weight: 700; color: #f8fafc;">0%
                                </div>
                            </div>
                            <!-- Avg MDD -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    Avg MDD</div>
                                <div id="rbMainMdd" style="font-size: 1.3rem; font-weight: 700; color: #3b82f6;">0%
                                </div>
                            </div>
                            <!-- Avg Win Rate -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    Avg Win Rate</div>
                                <div id="rbMainWinRate" style="font-size: 1.3rem; font-weight: 700; color: #10b981;">0%
                                </div>
                            </div>
                            <!-- Avg SQN -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    Avg SQN</div>
                                <div id="rbMainSqn" style="font-size: 1.3rem; font-weight: 700; color: #fbbf24;">0.00
                                </div>
                            </div>
                            <!-- R-Squared -->
                            <div
                                style="background: #0f172a; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #334155;">
                                <div
                                    style="color: #94a3b8; font-size: 0.85rem; margin-bottom: 0.4rem; font-weight: 500;">
                                    R-Squared</div>
                                <div id="rbMainR2" style="font-size: 1.3rem; font-weight: 700; color: #f8fafc;">0.00
                                </div>
                            </div>
                        </div>

                        <!-- Legend -->
                        <div id="rbMainLegend" class="hidden"
                            style="margin-top: 1rem; font-size: 0.85rem; color: #cbd5e1; background: #0f172a; padding: 1rem; border-radius: 8px; border: 1px solid #334155; line-height: 1.6;">
                            <strong style="color: #fff; display:block; margin-bottom:0.3rem;">R-Squared Guide:</strong>
                            <div style="display:flex; flex-wrap: wrap; gap: 1rem;">
                                <span><span style="color: #10b981;">‚óè 1.0</span> : Ïù¥ÏÉÅÏ†ÅÏù∏ ÍøàÏùò Ïö∞ÏÉÅÌñ• (Perfect)</span>
                                <span><span style="color: #fbbf24;">‚óè 0.9+</span> : Îß§Ïö∞ ÌõåÎ•≠Ìïú Í∑†ÏßàÏÑ± (Excellent)</span>
                                <span><span style="color: #ef4444;">‚óè <0.5< /span> : Ïö¥Ïù¥ ÌÅ¨Í≤å ÏûëÏö©Ìï® (Volatile)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sensitivity Analysis (Main) -->
                <div id="sensitivityReport" class="hidden"
                    style="margin-bottom: 2rem; background: #1e293b; padding: 1.5rem; border-radius: 12px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom: 1px solid #475569; padding-bottom: 0.5rem;">
                        <h3
                            style="margin:0; font-size:1.2rem; color:#f8fafc; display:flex; align-items:center; gap:0.5rem;">
                            <span>üéØ</span> Parameter Sensitivity (CSR Heatmap)
                        </h3>
                        <div id="senMainStatus" style="font-size:0.9rem; color:#64748b; font-style:italic;">Ready</div>
                    </div>

                    <!-- Progress -->
                    <div id="senMainLoading" class="hidden"
                        style="width:100%; height:4px; background:#334155; border-radius:2px; overflow:hidden; margin-bottom:1rem;">
                        <div id="senMainProgress"
                            style="width:0%; height:100%; background:linear-gradient(90deg, #ec4899, #8b5cf6); transition:width 0.3s;">
                        </div>
                    </div>

                    <div id="senMainContent" class="hidden" style="display:flex; gap:2rem; flex-wrap:wrap;">
                        <!-- Left: CSR Score -->
                        <div
                            style="flex:1; min-width:220px; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f172a; border-radius:1rem; padding:1.5rem; border:1px solid #334155;">
                            <div
                                style="font-size:0.9rem; color:#94a3b8; font-weight:bold; margin-bottom:0.5rem; letter-spacing:1px;">
                                CSR SCORE</div>
                            <div id="senMainCsrScore"
                                style="font-size:3.5rem; font-weight:800; color:#3b82f6; line-height:1; text-shadow:0 0 20px rgba(59,130,246,0.3);">
                                0.00</div>
                            <div id="senMainCsrText"
                                style="font-size:1.3rem; font-weight:bold; color:#f1f5f9; margin-top:1rem;">-</div>
                            <div
                                style="font-size:0.8rem; color:#64748b; margin-top:1rem; text-align:center; line-height:1.5;">
                                <span style="color:#10b981;">‚óè ~1.0</span> : Plateau (Safe)<br>
                                <span style="color:#ef4444;">‚óè <0.8< /span> : Peak (Risky)
                            </div>
                        </div>

                        <!-- Right: Heatmap -->
                        <div style="flex:2; min-width:300px;">
                            <div style="text-align:center; font-size:0.8rem; color:#94a3b8; margin-bottom:10px;">
                                X: Buy Limit (¬±2%) | Y: Profit Target (¬±2%)
                            </div>
                            <!-- Center Highlight Info -->
                            <div style="text-align:center; font-size:0.75rem; color:#64748b; margin-bottom:5px;">Center
                                = Current Param</div>

                            <div id="senMainHeatmap" class="heatmap-grid"
                                style="display:grid; gap:3px; justify-content:center; padding:10px; background:#0f172a; border-radius:8px; border:1px solid #334155;">
                                <!-- Grid injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Ledger Table (Moved Top) -->
                <div class="table-container">
                    <table id="ledgerTable">
                        <colgroup>
                            <col style="width: 72px; min-width: 72px; max-width: 72px;">
                            <col> <!-- Close -->
                            <col> <!-- Mode -->
                            <col> <!-- Change -->
                            <!-- Combine others or leave auto -->
                        </colgroup>
                        <thead>
                            <tr class="header-group">
                                <th rowspan="2"
                                    style="width: 72px; max-width: 72px; text-align: center !important; padding: 0 2px;">
                                    ÎÇ†Ïßú
                                </th>
                                <th rowspan="2">Ï¢ÖÍ∞Ä</th>
                                <th rowspan="2">Îß§Îß§Î™®Îìú</th>
                                <th rowspan="2">Îì±ÎùΩÎ•†</th>
                                <th colspan="6" class="th-group-buy">Îß§Ïàò (Buy)</th>
                                <th colspan="6" class="th-group-sell">Îß§ÎèÑ (Sell)</th>
                                <th colspan="4" class="th-group-pnl">ÏàòÏùµ (PnL)</th>
                                <th colspan="4" class="th-group-asset">ÏûêÏÇ∞ (Asset)</th>
                                <th colspan="1" class="th-group-etc">Í∏∞ÌÉÄ</th>
                            </tr>
                            <tr class="header-sub">
                                <!-- Buy Group -->
                                <th>Ìã∞Ïñ¥</th>
                                <th>Ìï†ÎãπÍ∏àÏï°</th>
                                <th>LOCÎß§ÏàòÎ™©Ìëú</th>
                                <th>Îß§ÏàòÍ∞Ä</th>
                                <th>Îß§ÏàòÎüâ</th>
                                <th>Îß§ÏàòÍ∏àÏï°</th>
                                <!-- Sell Group -->
                                <th>Î™©ÌëúÍ∞Ä</th>
                                <th>MOCÎß§ÎèÑ</th>
                                <th>Îß§ÎèÑÏùº</th>
                                <th>Îß§ÎèÑÍ∞Ä</th>
                                <th>Îß§ÎèÑÎüâ</th>
                                <th>Îß§ÎèÑÍ∏àÏï°</th>
                                <!-- PnL Group -->
                                <th>ÏàòÏàòÎ£å</th>
                                <th>ÏàúÏùµÍ∏àÏï°</th>
                                <th>ÏàúÏùµÎ•†</th>
                                <th>ÎàÑÏ†ÅÏàúÏùµ</th>
                                <!-- Asset Group -->
                                <th>ÏûêÍ∏àÍ∞±Ïã†</th>
                                <th>ÏãúÎìúÏ¥ùÏï°</th>
                                <th>Ï¥ùÏûêÏÇ∞</th>
                                <th>ÏòàÏàòÍ∏à</th>
                                <!-- Etc Group -->
                                <th>DD</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>



                <!-- Charts Area -->
                <div class="chart-container hidden" id="containerCash">
                    <canvas id="cashChart"></canvas>
                </div>
                <div class="chart-container hidden" id="containerAsset">
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="chart-container hidden" id="containerDD" style="height: 200px;">
                    <canvas id="ddChart"></canvas>
                </div>

            </section>
        </main>

        <!-- Parameter Warehouse Bottom Sheet -->
        <div id="warehouseWrapper" style="display:none;">
            <h3
                style="font-size: 1rem; color: #059669; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>üè≠</span> ÌååÎùºÎØ∏ÌÑ∞ Ï∞ΩÍ≥† (Parameter Warehouse)
            </h3>
            <div id="warehouseList">
                <div style="color: #64748b; font-size: 0.9rem;">No params in warehouse.</div>
            </div>
        </div>

        <!-- Saved Strategies Bottom Sheet (Renamed to Temporary) -->
        <div id="mainSavedStrategiesWrapper" style="display:none;"> <!-- Hidden initially, shown by JS -->
            <h3 style="font-size: 1rem; color: #8b5cf6; margin-bottom: 0.5rem;">üì¶ ÏûÑÏãúÎ≥¥Í¥ÄÌï® (Temporary Storage)</h3>
            <div id="mainSavedStrategies">
                <!-- JS will inject cards here -->
                <div style="color: #64748b; font-size: 0.9rem;">No saved strategies.</div>
            </div>
        </div>
    </div>

    <!-- DEEP MIND VIEW (Overlay) -->
    <div id="deepMindView" class="hidden">
        <div class="dm-container">
            <!-- Header -->
            <div class="dm-header">
                <div>
                    <h2>üß† DEEP MIND AI</h2>
                    <p>Global Search & Robustness Analysis</p>
                </div>
                <button id="btnCloseDM" class="dm-close-btn">BACK</button>
            </div>

            <!-- Deep Mind Configuration Panel (NEW) -->
            <div id="dmConfig" class="dm-card"
                style="margin-bottom:1rem; padding:1.5rem; background:#1e293b; border:1px solid #334155;">
                <h3 style="margin-top:0; color:#fbbf24; border-bottom:1px solid #475569; padding-bottom:0.5rem;">üõ†Ô∏è
                    Search Range Configuration</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem; margin-top:1rem;">
                    <!-- Safe Mode Ranges -->
                    <div>
                        <h4
                            style="color:#d1d5db; margin-bottom:0.5rem; border-left:3px solid #10b981; padding-left:8px;">
                            üõ°Ô∏è Safe Mode Ranges</h4>
                        <div class="form-row">
                            <label>Buy Limit (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmSafeBuyMin" value="0" style="width:60px;"> ~ <input
                                    type="number" id="dmSafeBuyMax" value="10" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Target (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmSafeTargetMin" value="0" style="width:60px;"> ~ <input
                                    type="number" id="dmSafeTargetMax" value="10" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Time Cut (Days)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmSafeTimeMin" value="5" style="width:60px;"> ~ <input
                                    type="number" id="dmSafeTimeMax" value="60" style="width:60px;">
                            </div>
                        </div>
                    </div>

                    <!-- Offensive Mode Ranges -->
                    <div>
                        <h4
                            style="color:#d1d5db; margin-bottom:0.5rem; border-left:3px solid #ef4444; padding-left:8px;">
                            ‚öîÔ∏è Offensive Mode Ranges</h4>
                        <div class="form-row">
                            <label>Buy Limit (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmOffBuyMin" value="0" style="width:60px;"> ~ <input
                                    type="number" id="dmOffBuyMax" value="10" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Target (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmOffTargetMin" value="0" style="width:60px;"> ~ <input
                                    type="number" id="dmOffTargetMax" value="10" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Time Cut (Days)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmOffTimeMin" value="5" style="width:60px;"> ~ <input
                                    type="number" id="dmOffTimeMax" value="60" style="width:60px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rebalance Ranges -->
                <div style="margin-top:1rem; border-top:1px solid #334155; padding-top:1rem;">
                    <h4 style="color:#d1d5db; margin-bottom:0.5rem; border-left:3px solid #3b82f6; padding-left:8px;">‚öñÔ∏è
                        Rebalance Ranges</h4>
                    <div style="display:flex; gap:2rem;">
                        <div class="form-row" style="flex:1;">
                            <label>Profit Add (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmProfitAddMin" value="40" style="width:60px;"> ~ <input
                                    type="number" id="dmProfitAddMax" value="100" style="width:60px;">
                            </div>
                        </div>
                        <div class="form-row" style="flex:1;">
                            <label>Loss Sub (%)</label>
                            <div style="display:flex; gap:5px; align-items:center;">
                                <input type="number" id="dmLossSubMin" value="0" style="width:60px;"> ~ <input
                                    type="number" id="dmLossSubMax" value="40" style="width:60px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Iterations Config -->
                <div style="margin-top:1rem; border-top:1px solid #334155; padding-top:1rem;">
                    <div class="form-row">
                        <label style="color:#fbbf24; font-weight:bold;">üß¨ Number of Simulations (Random Seeds)</label>
                        <input type="number" id="dmIterations" value="500"
                            style="width:100px; padding:5px; border-radius:4px; border:1px solid #475569; background:#0f172a; color:white;">
                    </div>
                </div>

                <div style="margin-top:1.5rem;">
                    <button id="btnStartDeepMind" class="primary-btn"
                        style="width:100%; background: linear-gradient(135deg, #10b981, #3b82f6); font-size:1.1rem; padding:1rem; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);">
                        üöÄ START DEEP MIND SEARCH
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div id="dmLoading" class="hidden">
                <div class="spinner"></div>
                <h3 id="dmLoadingText">AIÍ∞Ä ÏµúÏ†ÅÏùò ÌååÎùºÎØ∏ÌÑ∞Î•º ÌÉêÏÉâ Ï§ëÏûÖÎãàÎã§...</h3>
                <div class="progress-bar">
                    <div id="dmProgress" style="width: 0%"></div>
                </div>
                <p id="dmProgressText">0 / 1000</p>
            </div>

            <!-- Step 1: Top 10 Table -->
            <div id="dmResults" class="hidden">
                <h3>üèÜ Top 10 Candidates (Sorted by CAGR)</h3>
                <div class="dm-table-wrapper">
                    <table id="dmTable">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>CAGR</th>
                                <th>MDD</th>
                                <th>Win Rate</th>
                                <th>SQN</th>
                                <th>Profit Factor</th>
                                <th>Params (Summary)</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Saved Strategies Section (Added) -->
                <div id="mainSavedStrategiesWrapper" class="hidden"
                    style="margin-top:2rem; padding-top:1rem; border-top:1px solid #334155;">
                    <h3 style="color:#d1d5db; margin-bottom:1rem;">üìÇ Saved Strategies</h3>
                    <div id="savedStrategiesView" class="saved-grid">
                        <div style="color:#64748b; font-style:italic;">Ï†ÄÏû•Îêú ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Modal for Robustness -->
            <div id="dmModal" class="hidden">
                <div class="dm-modal-content">
                    <span id="btnModalClose" class="dm-modal-close">&times;</span>
                    <h3>üî¨ Robustness Analysis (Deep Dive)</h3>

                    <!-- NEW: Parameter Display (Clean, High Visibility) -->
                    <div id="dmParamsDisplay"
                        style="background: #1e293b; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #475569; position: relative;">
                        <!-- Parameters will be injected here by JS -->
                        <div style="text-align: center; color: #94a3b8;">Loading Parameters...</div>
                    </div>

                    <!-- Modal Progress -->
                    <div id="rbLoading" class="hidden" style="margin-bottom: 1rem;">
                        <div class="progress-bar" style="height: 6px; margin: 0.5rem 0;">
                            <div id="rbProgress" style="width: 0%"></div>
                        </div>
                        <p id="rbProgressText" style="text-align: right; color: #94a3b8; font-size: 0.8rem; margin: 0;">
                            0 / 1000</p>
                    </div>

                    <div class="dm-stat-grid">
                        <div class="dm-card">
                            <div class="label">Survival Rate</div>
                            <div class="value" id="rbSurvival">0%</div>
                        </div>
                        <div class="dm-card">
                            <div class="label">Avg CAGR</div>
                            <div class="value" id="rbCagr">0%</div>
                        </div>
                        <div class="dm-card">
                            <div class="label">Avg MDD</div>
                            <div class="value" id="rbMdd">0%</div>
                        </div>
                        <div class="dm-card">
                            <div class="label">Avg SQN</div>
                            <div class="value" id="rbSqn">0.00</div>
                        </div>
                        <div class="dm-card">
                            <div class="label">R-Squared (Equity)</div>
                            <div class="value" id="rbR2">0.00</div>
                        </div>
                    </div>

                    <!-- Sensitivity Analysis (Deep Dive) -->
                    <div id="dmSensitivityReport" class="hidden"
                        style="margin-top:1.5rem; background:#1e293b; padding:1.5rem; border-radius:8px; border:1px solid #475569;">
                        <h3 style="margin:0 0 1rem 0; font-size:1.1rem; color:#f8fafc;">üéØ Parameter Sensitivity (CSR)
                        </h3>
                        <!-- Progress -->
                        <div id="senDmLoading" class="hidden"
                            style="width:100%; height:4px; background:#334155; border-radius:2px; overflow:hidden; margin-bottom:1rem;">
                            <div id="senDmProgress"
                                style="width:0%; height:100%; background:linear-gradient(90deg, #ec4899, #8b5cf6); transition:width 0.3s;">
                            </div>
                        </div>

                        <div id="senDmContent" class="hidden" style="display:flex; gap:1.5rem; flex-wrap:wrap;">
                            <!-- Left: CSR Score -->
                            <div
                                style="flex:1; min-width:180px; display:flex; flex-direction:column; justify-content:center; align-items:center; background:#0f172a; border-radius:8px; padding:1rem; border:1px solid #334155;">
                                <div style="font-size:0.8rem; color:#94a3b8; font-weight:bold; margin-bottom:0.5rem;">
                                    CSR SCORE</div>
                                <div id="senDmCsrScore"
                                    style="font-size:2.5rem; font-weight:800; color:#3b82f6; line-height:1;">-</div>
                                <div id="senDmCsrText"
                                    style="font-size:1.1rem; font-weight:bold; color:#f1f5f9; margin-top:0.5rem;">-
                                </div>
                            </div>
                            <!-- Right: Heatmap -->
                            <div style="flex:2; min-width:250px;">
                                <div style="text-align:center; font-size:0.75rem; color:#64748b; margin-bottom:5px;">X:
                                    Buy Limit (¬±2%) | Y: Target (¬±2%)</div>
                                <div id="senDmHeatmap" class="heatmap-grid"
                                    style="display:grid; gap:2px; justify-content:center;">
                                    <!-- Grid -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:1rem; font-size:0.9rem; color:#ccc;">
                        * Based on 1,000 random starts (2-4 months duration)
                    </div>

                    <!-- NEW: Deep Drill Button & Actions -->
                    <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #334155;">
                        <div style="display: flex; gap: 10px; margin-bottom: 0.5rem;">
                            <button id="btnBackToList" class="action-btn"
                                style="background: #475569; flex:1; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">
                                ‚óÄ BACK TO LIST
                            </button>
                            <button id="btnSaveStrategy" class="action-btn"
                                style="background: #059669; flex:1; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">
                                üíæ SAVE PARAMETERS
                            </button>
                        </div>
                        <button id="btnDeepDrill" class="primary-btn" style="
                            width: 100%;
                            background: linear-gradient(135deg, #ec4899, #8b5cf6);
                            color: white;
                            font-weight: bold;
                            padding: 0.8rem 2rem;
                            border: none;
                            border-radius: 9999px;
                            font-size: 1rem;
                            cursor: pointer;
                            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.4);
                            transition: transform 0.2s;
                        " onmouseover="this.style.transform='scale(1.02)'"
                            onmouseout="this.style.transform='scale(1)'">
                            üíé DEEP DRILL (Apply & Run)
                        </button>
                    </div>
                    <p style="text-align:center; color:#64748b; font-size:0.8em; margin-top:0.5rem;">
                        * Save Parameters to store this setup. Deep Drill applies it immediately.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Injection Input Modal -->
    <div id="injectionModal" class="modal hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; display: flex; justify-content: center; align-items: center;">
        <div class="modal-content"
            style="background: white; padding: 2rem; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
            <h3 id="injModalTitle" style="margin-bottom: 15px;">ÏûêÍ∏à Î≥ÄÎèô Ïã†Ï≤≠</h3>
            <label style="display:block; text-align:left; font-size:0.9rem; color:#64748b;">Î≥ÄÎèô Í∏àÏï° ($)</label>
            <input type="number" id="injAmount" placeholder="Ïòà: 1000 or -500"
                style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #cbd5e1; border-radius: 6px;">

            <label style="display:block; text-align:left; font-size:0.9rem; color:#64748b;">Ï†ÅÏö© Ìù¨Îßù ÎÇ†Ïßú</label>
            <input type="date" id="injDate"
                style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #cbd5e1; border-radius: 6px;">
            <div id="injDateMsg" class="hidden"
                style="margin-bottom: 20px; font-size: 0.9rem; color: #10b981; font-weight: bold; background: #ecfdf5; padding: 10px; border-radius: 6px;">
                üîÑ Îã§Ïùå ÏûêÍ∏à Í∞±Ïã†(Î¶¨Î∞∏Îü∞Ïã±)ÏùºÏóê<br>ÏûêÎèôÏúºÎ°ú Ìï©ÏÇ∞ÎêòÏñ¥ Î∞òÏòÅÎê©ÎãàÎã§.
            </div>

            <div style="display: flex; gap: 10px;">
                <button id="btnSaveInj"
                    style="flex: 1; background: #2563eb; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Ï∂îÍ∞Ä</button>
                <button id="btnCloseInj"
                    style="flex: 1; background: #94a3b8; color: white; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Ï∑®ÏÜå</button>
            </div>
            <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <button id="btnViewInjHistory"
                    style="background:none; border:none; color:#64748b; text-decoration:underline; cursor:pointer; font-size:0.9rem;">
                    üìã Ïù¥Î≤à Ï£ºÍ∏∞ Î≥ÄÎèô Ïã†Ï≤≠ ÎÇ¥Ïó≠ Î≥¥Í∏∞
                </button>
            </div>
        </div>
    </div>

    <!-- Injection History Modal -->
    <div id="injectionHistoryModal" class="modal hidden"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2200; display: flex; justify-content: center; align-items: center;">
        <div class="modal-content"
            style="background: white; padding: 2rem; border-radius: 12px; width: 400px; max-height: 80vh; overflow-y:auto; text-align: center;">
            <h3 style="margin-bottom: 15px;">üìã Î≥ÄÎèô Ïã†Ï≤≠ ÎÇ¥Ïó≠</h3>
            <ul id="injHistoryList" style="list-style:none; padding:0; text-align:left; margin-bottom:20px;">
                <!-- Items will be injected here -->
            </ul>
            <button id="btnCloseInjHistory"
                style="background: #94a3b8; color: white; padding: 8px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Îã´Í∏∞</button>
        </div>
    </div>

</body>

</html>